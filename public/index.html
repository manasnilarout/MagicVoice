<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hindi Voice Bot - WebRTC & Twilio</title>
    <style>
      :root {
        --bg: #0b1220;
        --fg: #e8eefc;
        --muted: #9fb0d4;
        --accent: #6aa1ff;
        --success: #22c55e;
        --warning: #f59e0b;
        --danger: #ef4444;
      }
      * {
        box-sizing: border-box;
      }
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background: var(--bg);
        color: var(--fg);
        display: flex;
        flex-direction: column;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        width: 100%;
      }
      h1 {
        font-size: 28px;
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--fg);
      }
      .subtitle {
        color: var(--muted);
        margin-bottom: 30px;
        font-size: 16px;
      }
      .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      .card {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 24px;
        display: flex;
        flex-direction: column;
        min-height: 500px;
      }
      .card h2 {
        margin: 0 0 16px 0;
        font-size: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .card-icon {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
      }
      .webrtc-icon {
        background: var(--accent);
        color: #021226;
      }
      .twilio-icon {
        background: var(--success);
        color: #021226;
      }
      .description {
        color: var(--muted);
        margin-bottom: 20px;
        line-height: 1.5;
      }
      .controls {
        margin-bottom: 20px;
      }
      .input-group {
        margin-bottom: 16px;
      }
      .input-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: var(--fg);
      }
      .input-group input {
        width: 100%;
        padding: 12px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 8px;
        color: var(--fg);
        font-size: 14px;
      }
      .input-group input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(106, 161, 255, 0.2);
      }
      button {
        appearance: none;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: transparent;
        color: var(--fg);
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s ease;
        margin-right: 10px;
        margin-bottom: 10px;
      }
      button.primary {
        background: var(--accent);
        color: #021226;
        border-color: transparent;
      }
      button.success {
        background: var(--success);
        color: #021226;
        border-color: transparent;
      }
      button.danger {
        background: var(--danger);
        color: white;
        border-color: transparent;
      }
      button:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      .status {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        font-weight: 500;
      }
      .status.disconnected {
        background: rgba(159, 176, 212, 0.1);
        color: var(--muted);
      }
      .status.connecting {
        background: rgba(245, 158, 11, 0.15);
        color: var(--warning);
      }
      .status.connected {
        background: rgba(34, 197, 94, 0.15);
        color: var(--success);
      }
      .status.error {
        background: rgba(239, 68, 68, 0.15);
        color: var(--danger);
      }
      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
      }
      .status.connecting .status-dot {
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      .logs {
        flex: 1;
        background: rgba(0, 0, 0, 0.4);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        padding: 16px;
        overflow-y: auto;
        font-family: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace;
        font-size: 12px;
        line-height: 1.4;
        max-height: 300px;
      }
      .log-entry {
        margin-bottom: 4px;
        word-wrap: break-word;
      }
      .log-timestamp {
        color: var(--muted);
        opacity: 0.7;
      }
      .log-message {
        color: var(--fg);
      }
      .log-message.error {
        color: var(--danger);
      }
      .log-message.success {
        color: var(--success);
      }
      audio {
        display: none;
      }
      .phone-input {
        font-family: monospace;
      }
      .hint {
        font-size: 12px;
        color: var(--muted);
        opacity: 0.8;
        margin-top: 4px;
      }
      .language-selection {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .language-selection .input-group {
        margin-bottom: 0;
      }
      select {
        appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23e8eefc" d="M2 0L0 2h4zm0 5L0 3h4z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 12px;
      }
      select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(106, 161, 255, 0.2);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Multi-Language Voice Bot</h1>
      <p class="subtitle">Fibe NBFC Collection Agent - WebRTC Browser Calls & Twilio Phone Calls</p>
      
      <div class="language-selection">
        <div class="input-group">
          <label for="languageSelect">Select Language</label>
          <select id="languageSelect" style="width: 100%; padding: 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.16); border-radius: 8px; color: var(--fg); font-size: 14px;">
            <option value="hindi">Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)</option>
            <option value="kannada">Kannada (‡≤ï‡≤®‡≥ç‡≤®‡≤°)</option>
            <option value="telugu">Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
          </select>
        </div>
      </div>
      
      <div class="cards-grid">
        <!-- WebRTC Card -->
        <div class="card">
          <h2>
            <div class="card-icon webrtc-icon">üé§</div>
            Browser Voice Call
          </h2>
          <p class="description">
            Talk directly to the Hindi-speaking bot through your browser using WebRTC. 
            Click start and grant microphone permission to begin the conversation.
          </p>
          
          <div class="controls">
            <button id="webrtcStart" class="primary">Start Voice Chat</button>
          </div>
          
          <div class="status disconnected" id="webrtcStatus">
            <div class="status-dot"></div>
            <span>Disconnected</span>
          </div>
          
          <div class="logs" id="webrtcLogs"></div>
        </div>

        <!-- Twilio Card -->
        <div class="card">
          <h2>
            <div class="card-icon twilio-icon">üìû</div>
            Phone Call (Twilio)
          </h2>
          <p class="description">
            Make an outbound phone call to any number. The bot will call the number 
            and start speaking in Hindi once the call is answered.
          </p>
          
          <div class="controls">
            <div class="input-group">
              <label for="phoneNumber">Phone Number</label>
              <input 
                type="tel" 
                id="phoneNumber" 
                class="phone-input"
                placeholder="+919876543210" 
                pattern="^\+[1-9]\d{1,14}$"
              />
              <div class="hint">Use E.164 format (e.g., +919876543210 for India)</div>
            </div>
            
            <button id="startCallBtn" class="success">Start Call</button>
            <button id="endCallBtn" class="danger" disabled>End Call</button>
          </div>
          
          <div class="status disconnected" id="twilioStatus">
            <div class="status-dot"></div>
            <span>Ready to call</span>
          </div>
          
          <div class="logs" id="twilioLogs"></div>
        </div>
      </div>
    </div>

    <audio id="remoteAudio" autoplay playsinline></audio>

    <script>
      // Utility functions
      const $ = (id) => document.getElementById(id);
      
      function formatTimestamp() {
        const now = new Date();
        return now.toLocaleTimeString() + '.' + String(now.getMilliseconds()).padStart(3, '0');
      }

      function getSelectedLanguage() {
        return $('languageSelect').value;
      }

      function addLog(containerId, message, type = 'info') {
        const logsEl = $(containerId);
        const timestamp = formatTimestamp();
        
        const logEntry = document.createElement("div");
        logEntry.className = "log-entry";
        logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> <span class="log-message ${type}">${message}</span>`;
        
        logsEl.appendChild(logEntry);
        logsEl.scrollTop = logsEl.scrollHeight;
        console.log(`[${timestamp}] ${message}`);
      }

      function updateStatus(statusId, text, className) {
        const statusEl = $(statusId);
        statusEl.className = `status ${className}`;
        statusEl.querySelector('span').textContent = text;
      }

      // WebRTC functionality
      let pc = null;
      let localStream = null;
      let isConnected = false;

      async function startWebRTC() {
        if (pc) {
          await stopWebRTC();
          return;
        }

        updateStatus('webrtcStatus', 'Initializing...', 'connecting');
        addLog('webrtcLogs', 'Starting WebRTC voice connection');
        
        try {
          // Get microphone permission
          localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          const audioTrack = localStream.getAudioTracks()[0];
          addLog('webrtcLogs', `Microphone access granted: ${audioTrack.label}`, 'success');

          // Create peer connection
          pc = new RTCPeerConnection({});
          
          pc.onconnectionstatechange = () => {
            addLog('webrtcLogs', `Connection state: ${pc.connectionState}`);
            if (pc.connectionState === 'connected') {
              updateStatus('webrtcStatus', 'Connected - Talking to bot', 'connected');
              $('webrtcStart').textContent = 'Stop Voice Chat';
            } else if (pc.connectionState === 'failed') {
              updateStatus('webrtcStatus', 'Connection failed', 'error');
            } else if (pc.connectionState === 'disconnected') {
              updateStatus('webrtcStatus', 'Connection interrupted', 'error');
            }
          };

          // Handle remote audio
          pc.ontrack = (ev) => {
            if (ev.track.kind === 'audio') {
              addLog('webrtcLogs', 'Received audio from bot', 'success');
              $('remoteAudio').srcObject = ev.streams[0] || new MediaStream([ev.track]);
            }
          };

          // Add local audio
          localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
          
          // Create data channel
          const dc = pc.createDataChannel('');
          dc.onmessage = (msg) => {
            const parsed = JSON.parse(msg.data);
            if (parsed.type === 'session.created') {
              addLog('webrtcLogs', `Session created: ${parsed.session.id}`, 'success');
            }
          };

          // Create offer and connect
          addLog('webrtcLogs', 'Creating offer and connecting to server...');
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);

          const resp = await fetch('/rtc', {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/sdp',
              'X-Language': getSelectedLanguage()
            },
            body: offer.sdp,
          });

          if (!resp.ok) {
            const errText = await resp.text().catch(() => '<no body>');
            throw new Error(`Server error: ${resp.status} ${errText}`);
          }

          const location = resp.headers.get('Location');
          const callId = location?.split('/').pop();
          addLog('webrtcLogs', `Call created: ${callId}`, 'success');

          const answerSdp = await resp.text();
          await pc.setRemoteDescription({
            type: 'answer',
            sdp: answerSdp,
          });

        } catch (error) {
          addLog('webrtcLogs', `Connection failed: ${error.message}`, 'error');
          updateStatus('webrtcStatus', 'Connection failed', 'error');
          await stopWebRTC();
        }
      }

      async function stopWebRTC() {
        addLog('webrtcLogs', 'Stopping WebRTC connection');
        updateStatus('webrtcStatus', 'Disconnecting...', 'connecting');

        if (pc) {
          pc.getSenders().forEach(s => {
            try { s.track && s.track.stop(); } catch {}
          });
          pc.getReceivers().forEach(r => {
            try { r.track && r.track.stop(); } catch {}
          });
          pc.close();
          pc = null;
        }

        if (localStream) {
          localStream.getTracks().forEach(t => {
            try { t.stop(); } catch {}
          });
          localStream = null;
        }

        $('remoteAudio').srcObject = null;
        updateStatus('webrtcStatus', 'Disconnected', 'disconnected');
        $('webrtcStart').textContent = 'Start Voice Chat';
        addLog('webrtcLogs', 'WebRTC connection stopped');
      }

      // Twilio functionality
      let currentCallSid = null;

      async function startTwilioCall() {
        const phoneNumber = $('phoneNumber').value.trim();
        
        if (!phoneNumber) {
          addLog('twilioLogs', 'Please enter a phone number', 'error');
          return;
        }

        // Validate phone number format
        if (!phoneNumber.match(/^\+[1-9]\d{1,14}$/)) {
          addLog('twilioLogs', 'Invalid phone number format. Use E.164 format (e.g., +919876543210)', 'error');
          return;
        }

        try {
          updateStatus('twilioStatus', 'Initiating call...', 'connecting');
          $('startCallBtn').disabled = true;
          
          addLog('twilioLogs', `Calling ${phoneNumber}...`);
          
          const response = await fetch('/twilio-realtime/call', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              phoneNumber,
              language: getSelectedLanguage()
            })
          });

          const data = await response.json();
          
          if (data.success) {
            currentCallSid = data.callSid;
            updateStatus('twilioStatus', 'Call in progress', 'connected');
            $('endCallBtn').disabled = false;
            addLog('twilioLogs', `Call initiated successfully. SID: ${data.callSid}`, 'success');
          } else {
            throw new Error(data.error || 'Failed to initiate call');
          }
        } catch (error) {
          addLog('twilioLogs', `Call failed: ${error.message}`, 'error');
          updateStatus('twilioStatus', 'Call failed', 'error');
        } finally {
          $('startCallBtn').disabled = false;
        }
      }

      async function endTwilioCall() {
        if (!currentCallSid) return;

        try {
          updateStatus('twilioStatus', 'Ending call...', 'connecting');
          $('endCallBtn').disabled = true;
          
          addLog('twilioLogs', `Ending call ${currentCallSid}...`);
          
          // Note: You might want to implement a hangup endpoint
          // For now, we'll just reset the UI
          currentCallSid = null;
          updateStatus('twilioStatus', 'Ready to call', 'disconnected');
          addLog('twilioLogs', 'Call ended', 'success');
        } catch (error) {
          addLog('twilioLogs', `Error ending call: ${error.message}`, 'error');
        } finally {
          $('endCallBtn').disabled = true;
        }
      }

      // Event listeners
      $('webrtcStart').addEventListener('click', startWebRTC);
      $('startCallBtn').addEventListener('click', startTwilioCall);
      $('endCallBtn').addEventListener('click', endTwilioCall);

      // Phone number input validation
      $('phoneNumber').addEventListener('input', (e) => {
        const value = e.target.value;
        if (value && !value.startsWith('+')) {
          e.target.value = '+' + value.replace(/^\+*/, '');
        }
      });

      // Clean up on page unload
      window.addEventListener('beforeunload', () => {
        stopWebRTC();
      });

      // Initialize
      addLog('webrtcLogs', 'WebRTC interface ready');
      addLog('twilioLogs', 'Twilio interface ready');
      updateStatus('webrtcStatus', 'Disconnected', 'disconnected');
      updateStatus('twilioStatus', 'Ready to call', 'disconnected');
    </script>
  </body>
</html>