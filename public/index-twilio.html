<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Voice Bot - Twilio & OpenAI Realtime API</title>
    <style>
      :root {
        --bg: #0b1220;
        --fg: #e8eefc;
        --muted: #9fb0d4;
        --accent: #6aa1ff;
        --success: #22c55e;
        --warning: #f59e0b;
        --danger: #ef4444;
      }
      * {
        box-sizing: border-box;
      }
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background: var(--bg);
        color: var(--fg);
        display: flex;
        flex-direction: column;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        width: 100%;
      }
      h1 {
        font-size: 28px;
        font-weight: 600;
        margin-bottom: 30px;
        color: var(--fg);
      }
      .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      .card {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .card h2 {
        font-size: 20px;
        font-weight: 600;
        margin: 0 0 20px 0;
        color: var(--accent);
      }
      .input-group {
        margin-bottom: 20px;
      }
      .input-group label {
        display: block;
        font-size: 14px;
        color: var(--muted);
        margin-bottom: 8px;
      }
      .input-group input {
        width: 100%;
        padding: 10px 14px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 8px;
        color: var(--fg);
        font-size: 15px;
        transition: all 0.2s ease;
      }
      .input-group input:focus {
        outline: none;
        border-color: var(--accent);
        background: rgba(255, 255, 255, 0.08);
      }
      .input-group input::placeholder {
        color: rgba(159, 176, 212, 0.6);
      }
      button {
        appearance: none;
        border: none;
        background: var(--accent);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        width: 100%;
      }
      button:hover:not(:disabled) {
        background: #5390ef;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(106, 161, 255, 0.3);
      }
      button:active:not(:disabled) {
        transform: translateY(0);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      button.danger {
        background: var(--danger);
      }
      button.danger:hover:not(:disabled) {
        background: #dc2626;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      }
      .status {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .status-led {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--muted);
        transition: background-color 0.3s ease;
      }
      .status-led.connected {
        background: var(--success);
        box-shadow: 0 0 8px rgba(34, 197, 94, 0.4);
      }
      .status-led.connecting {
        background: var(--warning);
        animation: pulse 1.5s infinite;
      }
      .status-led.error {
        background: var(--danger);
        box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      .status-text {
        font-size: 14px;
        color: var(--muted);
      }
      .logs {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        padding: 12px;
        height: 200px;
        overflow-y: auto;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        font-size: 12px;
        line-height: 1.5;
      }
      .log-entry {
        margin-bottom: 4px;
        color: var(--muted);
      }
      .log-entry.error {
        color: var(--danger);
      }
      .log-entry.success {
        color: var(--success);
      }
      .button-group {
        display: flex;
        gap: 10px;
      }
      .button-group button {
        flex: 1;
      }
      .info-box {
        background: rgba(106, 161, 255, 0.1);
        border: 1px solid rgba(106, 161, 255, 0.3);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 20px;
        font-size: 14px;
        line-height: 1.5;
      }
      .info-box strong {
        color: var(--accent);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üé§ Multi-Language Voice Bot Control Panel</h1>
      
      <div class="language-selection" style="background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
        <div class="input-group">
          <label for="languageSelect">Select Language</label>
          <select id="languageSelect" style="width: 100%; padding: 10px 14px; background: rgba(255, 255, 255, 0.06); border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 8px; color: var(--fg); font-size: 15px; appearance: none;">
            <option value="hindi">Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)</option>
            <option value="kannada">Kannada (‡≤ï‡≤®‡≥ç‡≤®‡≤°)</option>
            <option value="telugu">Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
          </select>
        </div>
      </div>
      
      <div class="cards-grid">
        <!-- Twilio Phone Call Card -->
        <div class="card">
          <h2>üìû Twilio Phone Call</h2>
          
          <div class="info-box">
            <strong>Instructions:</strong><br>
            Enter a phone number with country code (e.g., +919876543210) and click "Start Call" to initiate an outbound call using Twilio.
          </div>
          
          <div class="status">
            <div id="twilioStatusLed" class="status-led"></div>
            <span id="twilioStatusText" class="status-text">Not connected</span>
          </div>
          
          <div class="input-group">
            <label for="phoneNumber">Phone Number</label>
            <input 
              type="tel" 
              id="phoneNumber" 
              placeholder="+919876543210"
              pattern="^\+[1-9]\d{1,14}$"
            />
          </div>
          
          <div class="button-group">
            <button id="startCallBtn" onclick="startTwilioCall()">
              Start Call
            </button>
            <button id="endCallBtn" class="danger" onclick="endTwilioCall()" disabled>
              End Call
            </button>
          </div>
          
          <h3 style="margin-top: 20px; font-size: 16px; color: var(--muted);">Call Logs</h3>
          <div id="twilioLogs" class="logs"></div>
        </div>

        <!-- WebRTC Browser Call Card -->
        <div class="card">
          <h2>üåê WebRTC Browser Call</h2>
          
          <div class="info-box">
            <strong>Instructions:</strong><br>
            Click "Start Browser Call" to connect directly from your browser using WebRTC. Make sure to allow microphone access when prompted.
          </div>
          
          <div class="status">
            <div id="webrtcStatusLed" class="status-led"></div>
            <span id="webrtcStatusText" class="status-text">Not connected</span>
          </div>
          
          <button id="webrtcBtn" onclick="toggleWebRTCCall()">
            Start Browser Call
          </button>
          
          <h3 style="margin-top: 20px; font-size: 16px; color: var(--muted);">Session Logs</h3>
          <div id="webrtcLogs" class="logs"></div>
        </div>
      </div>
    </div>

    <script>
      let pc = null;
      let currentCallSid = null;
      let isWebRTCActive = false;

      // Utility functions
      function getSelectedLanguage() {
        return document.getElementById('languageSelect').value;
      }

      // Logging functions
      function addLog(elementId, message, type = '') {
        const logsElement = document.getElementById(elementId);
        const entry = document.createElement('div');
        entry.className = 'log-entry ' + type;
        const timestamp = new Date().toLocaleTimeString();
        entry.textContent = `[${timestamp}] ${message}`;
        logsElement.appendChild(entry);
        logsElement.scrollTop = logsElement.scrollHeight;
      }

      // Twilio Call Functions
      async function startTwilioCall() {
        const phoneNumber = document.getElementById('phoneNumber').value;
        
        if (!phoneNumber) {
          addLog('twilioLogs', 'Please enter a phone number', 'error');
          return;
        }

        // Validate phone number format
        if (!phoneNumber.match(/^\+[1-9]\d{1,14}$/)) {
          addLog('twilioLogs', 'Invalid phone number format. Use E.164 format (e.g., +919876543210)', 'error');
          return;
        }

        try {
          updateTwilioStatus('connecting', 'Initiating call...');
          document.getElementById('startCallBtn').disabled = true;
          
          addLog('twilioLogs', `Calling ${phoneNumber}...`);
          
          const response = await fetch('/twilio-realtime/call', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              phoneNumber,
              language: getSelectedLanguage()
            })
          });

          const data = await response.json();
          
          if (data.success) {
            currentCallSid = data.callSid;
            updateTwilioStatus('connected', 'Call in progress');
            document.getElementById('endCallBtn').disabled = false;
            addLog('twilioLogs', `Call initiated successfully. SID: ${data.callSid}`, 'success');
          } else {
            throw new Error(data.error || 'Failed to initiate call');
          }
        } catch (error) {
          console.error('Call initiation error:', error);
          addLog('twilioLogs', `Error: ${error.message}`, 'error');
          updateTwilioStatus('error', 'Call failed');
          document.getElementById('startCallBtn').disabled = false;
        }
      }

      function endTwilioCall() {
        if (currentCallSid) {
          addLog('twilioLogs', 'Call ended by user');
          currentCallSid = null;
        }
        updateTwilioStatus('', 'Not connected');
        document.getElementById('startCallBtn').disabled = false;
        document.getElementById('endCallBtn').disabled = true;
      }

      function updateTwilioStatus(state, text) {
        const led = document.getElementById('twilioStatusLed');
        const statusText = document.getElementById('twilioStatusText');
        
        led.className = 'status-led';
        if (state) led.classList.add(state);
        statusText.textContent = text;
      }

      // WebRTC Functions
      async function toggleWebRTCCall() {
        if (isWebRTCActive) {
          endWebRTCCall();
        } else {
          startWebRTCCall();
        }
      }

      async function startWebRTCCall() {
        try {
          updateWebRTCStatus('connecting', 'Connecting...');
          addLog('webrtcLogs', 'Requesting microphone access...');
          
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          addLog('webrtcLogs', 'Microphone access granted', 'success');
          
          pc = new RTCPeerConnection({
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
          });

          pc.oniceconnectionstatechange = () => {
            addLog('webrtcLogs', `ICE state: ${pc.iceConnectionState}`);
            if (pc.iceConnectionState === 'connected') {
              updateWebRTCStatus('connected', 'Connected');
            } else if (pc.iceConnectionState === 'failed' || pc.iceConnectionState === 'disconnected') {
              updateWebRTCStatus('error', 'Connection lost');
            }
          };

          pc.ontrack = (event) => {
            const audio = new Audio();
            audio.srcObject = event.streams[0];
            audio.play();
            addLog('webrtcLogs', 'Receiving audio from bot', 'success');
          };

          stream.getTracks().forEach(track => pc.addTrack(track, stream));

          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          
          addLog('webrtcLogs', 'Connecting to OpenAI Realtime API...');
          
          const response = await fetch('/rtc', {
            method: 'POST',
            headers: { 
              'Content-Type': 'text/plain',
              'X-Language': getSelectedLanguage()
            },
            body: offer.sdp
          });

          if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
          }

          const answer = await response.text();
          await pc.setRemoteDescription({ type: 'answer', sdp: answer });
          
          isWebRTCActive = true;
          document.getElementById('webrtcBtn').textContent = 'End Browser Call';
          addLog('webrtcLogs', 'Connected to voice bot', 'success');
          
        } catch (error) {
          console.error('WebRTC error:', error);
          addLog('webrtcLogs', `Error: ${error.message}`, 'error');
          updateWebRTCStatus('error', 'Connection failed');
          endWebRTCCall();
        }
      }

      function endWebRTCCall() {
        if (pc) {
          pc.close();
          pc = null;
        }
        isWebRTCActive = false;
        updateWebRTCStatus('', 'Not connected');
        document.getElementById('webrtcBtn').textContent = 'Start Browser Call';
        addLog('webrtcLogs', 'Call ended');
      }

      function updateWebRTCStatus(state, text) {
        const led = document.getElementById('webrtcStatusLed');
        const statusText = document.getElementById('webrtcStatusText');
        
        led.className = 'status-led';
        if (state) led.classList.add(state);
        statusText.textContent = text;
      }

      // Initialize logs
      window.addEventListener('load', () => {
        addLog('twilioLogs', 'Ready to make calls');
        addLog('webrtcLogs', 'Ready for browser calls');
      });
    </script>
  </body>
</html>